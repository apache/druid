# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#-------------------------------------------------------------------------
apiVersion: apps/v1
kind: Deployment
metadata:
  name: druid-druid-test-brokers
  namespace: test-namespace
  labels:
    app: druid
    druid_cr: druid-test
    nodeSpecUniqueStr: druid-druid-test-brokers
    component: broker
  annotations:
    druidOpResourceHash: nQv/LmxctTSRsI5dtBe3jvN5WM8=
    kubernetes.io/cluster-scoped-annotation: "cluster"
    kubernetes.io/node-scoped-annotation: "broker"
    kubernetes.io/override-annotation: "node-scoped-annotation"
spec:
  replicas: 2
  selector:
    matchLabels:
      app: druid
      druid_cr: druid-test
      nodeSpecUniqueStr: druid-druid-test-brokers
      component: broker
  strategy:
    rollingUpdate: {}
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: druid
        druid_cr: druid-test
        nodeSpecUniqueStr: druid-druid-test-brokers
        component: broker
      annotations:
        key1: value1
        key2: value2
    spec:
      tolerations: []
      affinity: {}
      priorityClassName: high-priority
      containers:
        - command:
            - bin/run-druid.sh
            - broker
          image: himanshu01/druid:druid-0.12.0-1
          name: druid-druid-test-brokers
          env:
            - name: configMapSHA
              value: blah
          ports:
            - containerPort: 8083
              name: random
          readinessProbe:
            httpGet:
              path: /status
              port: 8080
          livenessProbe:
            httpGet:
              path: /status
              port: 8080
          startupProbe:
            failureThreshold: 20
            httpGet:
              path: /druid/broker/v1/readiness
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 5
          resources:
            limits:
              cpu: "4"
              memory: 2Gi
            requests:
              cpu: "4"
              memory: 2Gi
          volumeMounts:
            - mountPath: /druid/conf/druid/_common
              readOnly: true
              name: common-config-volume
            - mountPath: /druid/conf/druid/broker
              readOnly: true
              name: nodetype-config-volume
            - mountPath: /druid/data
              readOnly: true
              name: data-volume
      securityContext:
        fsGroup: 107
        runAsUser: 106
      volumes:
        - configMap:
            name: druid-test-druid-common-config
          name: common-config-volume
        - configMap:
            name: druid-druid-test-brokers-config
          name: nodetype-config-volume
