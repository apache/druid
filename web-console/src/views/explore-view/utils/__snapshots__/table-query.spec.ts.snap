// Jest Snapshot v1, https://goo.gl/fbAQLP

exports[`table-query uber test all queries match snapshot 1`] = `
"
===========================================
no group by, no show, no measures, no compare, no order by
-----
SELECT COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, no measures, compare PT1H, value+delta, no order by, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, no measures, compare PT1H, value+delta, no order by, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, no measures, compare PT1H, delta+percent, no order by, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, no measures, compare PT1H, delta+percent, no order by, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, no measures, compare PT1H, all compare types, no order by, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, no measures, compare PT1H, all compare types, no order by, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, one measure, no compare, no order by
-----
SELECT COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, one measure, no compare, order by Count
-----
SELECT COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, value+delta, no order by, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, value+delta, no order by, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, value+delta, order by Count, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, value+delta, order by Count, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, value+delta, Count/PT1H/value, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, value+delta, Count/PT1H/value, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, value+delta, Count/PT1H/delta, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, value+delta, Count/PT1H/delta, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, delta+percent, no order by, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, delta+percent, no order by, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, delta+percent, order by Count, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, delta+percent, order by Count, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, delta+percent, Count/PT1H/delta, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, delta+percent, Count/PT1H/delta, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, delta+percent, Count/PT1H/percent, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, delta+percent, Count/PT1H/percent, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, all compare types, no order by, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, all compare types, no order by, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, all compare types, order by Count, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, all compare types, order by Count, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, all compare types, Count/PT1H/value, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, all compare types, Count/PT1H/value, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, all compare types, Count/PT1H/delta, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, all compare types, Count/PT1H/delta, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, all compare types, Count/PT1H/absDelta, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, all compare types, Count/PT1H/absDelta, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, all compare types, Count/PT1H/percent, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, all compare types, Count/PT1H/percent, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, all compare types, Count/PT1H/absPercent, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
no group by, no show, one measure, compare PT1H, all compare types, Count/PT1H/absPercent, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
no group by, no show, two measures, no compare, no order by
-----
SELECT
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, two measures, no compare, order by Count
-----
SELECT
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, two measures, no compare, order by Unique sessions
-----
SELECT
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, value+delta, no order by, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, value+delta, no order by, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, value+delta, order by Count, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, value+delta, order by Count, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, value+delta, order by Unique sessions, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, value+delta, order by Unique sessions, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, value+delta, Count/PT1H/value, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, value+delta, Count/PT1H/value, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, value+delta, Count/PT1H/delta, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, value+delta, Count/PT1H/delta, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, value+delta, Unique sessions/PT1H/value, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, value+delta, Unique sessions/PT1H/value, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, value+delta, Unique sessions/PT1H/delta, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, value+delta, Unique sessions/PT1H/delta, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, delta+percent, no order by, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, delta+percent, no order by, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, delta+percent, order by Count, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, delta+percent, order by Count, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, delta+percent, order by Unique sessions, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, delta+percent, order by Unique sessions, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, delta+percent, Count/PT1H/delta, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, delta+percent, Count/PT1H/delta, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, delta+percent, Count/PT1H/percent, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, delta+percent, Count/PT1H/percent, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/delta, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/delta, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/percent, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/percent, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, no order by, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, no order by, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, order by Count, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, order by Count, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, order by Unique sessions, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, order by Unique sessions, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, Count/PT1H/value, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, Count/PT1H/value, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, Count/PT1H/delta, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, Count/PT1H/delta, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, Count/PT1H/absDelta, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, Count/PT1H/absDelta, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, Count/PT1H/percent, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, Count/PT1H/percent, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, Count/PT1H/absPercent, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, Count/PT1H/absPercent, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/value, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/value, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/delta, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/delta, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absDelta, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absDelta, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/percent, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/percent, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absPercent, restrict never
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
no group by, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absPercent, restrict always
-----
SELECT
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
no group by, show browser, no measures, no compare, no order by
-----
SELECT CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, no measures, no compare, order by Browser
-----
SELECT CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, no measures, compare PT1H, value+delta, no order by, restrict never
-----
SELECT CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, no measures, compare PT1H, value+delta, no order by, restrict always
-----
SELECT CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200"
`;

exports[`table-query uber test all queries match snapshot 2`] = `
"
===========================================
no group by, show browser, no measures, compare PT1H, value+delta, order by Browser, restrict never
-----
SELECT CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, no measures, compare PT1H, value+delta, order by Browser, restrict always
-----
SELECT CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, no measures, compare PT1H, delta+percent, no order by, restrict never
-----
SELECT CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, no measures, compare PT1H, delta+percent, no order by, restrict always
-----
SELECT CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, no measures, compare PT1H, delta+percent, order by Browser, restrict never
-----
SELECT CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, no measures, compare PT1H, delta+percent, order by Browser, restrict always
-----
SELECT CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, no measures, compare PT1H, all compare types, no order by, restrict never
-----
SELECT CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, no measures, compare PT1H, all compare types, no order by, restrict always
-----
SELECT CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, no measures, compare PT1H, all compare types, order by Browser, restrict never
-----
SELECT CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, no measures, compare PT1H, all compare types, order by Browser, restrict always
-----
SELECT CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, no compare, no order by
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, no compare, order by Browser
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, no compare, order by Count
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, value+delta, no order by, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, value+delta, no order by, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, value+delta, order by Browser, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, value+delta, order by Browser, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, value+delta, order by Count, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, value+delta, order by Count, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, value+delta, Count/PT1H/value, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, value+delta, Count/PT1H/value, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, value+delta, Count/PT1H/delta, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, value+delta, Count/PT1H/delta, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, delta+percent, no order by, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, delta+percent, no order by, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, delta+percent, order by Browser, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, delta+percent, order by Browser, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, delta+percent, order by Count, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, delta+percent, order by Count, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, delta+percent, Count/PT1H/delta, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, delta+percent, Count/PT1H/delta, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, delta+percent, Count/PT1H/percent, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, delta+percent, Count/PT1H/percent, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, all compare types, no order by, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, all compare types, no order by, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, all compare types, order by Browser, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, all compare types, order by Browser, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, all compare types, order by Count, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, all compare types, order by Count, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, all compare types, Count/PT1H/value, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, all compare types, Count/PT1H/value, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, all compare types, Count/PT1H/delta, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, all compare types, Count/PT1H/delta, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, all compare types, Count/PT1H/absDelta, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, all compare types, Count/PT1H/absDelta, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, all compare types, Count/PT1H/percent, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, all compare types, Count/PT1H/percent, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, all compare types, Count/PT1H/absPercent, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
no group by, show browser, one measure, compare PT1H, all compare types, Count/PT1H/absPercent, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, no compare, no order by
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, no compare, order by Browser
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, no compare, order by Count
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, no compare, order by Unique sessions
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, value+delta, no order by, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, value+delta, no order by, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, value+delta, order by Browser, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, value+delta, order by Browser, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, value+delta, order by Count, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, value+delta, order by Count, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, value+delta, order by Unique sessions, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, value+delta, order by Unique sessions, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, value+delta, Count/PT1H/value, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, value+delta, Count/PT1H/value, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, value+delta, Count/PT1H/delta, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, value+delta, Count/PT1H/delta, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, value+delta, Unique sessions/PT1H/value, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, value+delta, Unique sessions/PT1H/value, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, value+delta, Unique sessions/PT1H/delta, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, value+delta, Unique sessions/PT1H/delta, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, delta+percent, no order by, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, delta+percent, no order by, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, delta+percent, order by Browser, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, delta+percent, order by Browser, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, delta+percent, order by Count, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, delta+percent, order by Count, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, delta+percent, order by Unique sessions, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, delta+percent, order by Unique sessions, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, delta+percent, Count/PT1H/delta, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, delta+percent, Count/PT1H/delta, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, delta+percent, Count/PT1H/percent, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, delta+percent, Count/PT1H/percent, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/delta, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/delta, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/percent, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/percent, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, no order by, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, no order by, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, order by Browser, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, order by Browser, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Browser" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, order by Count, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, order by Count, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, order by Unique sessions, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, order by Unique sessions, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, Count/PT1H/value, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, Count/PT1H/value, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, Count/PT1H/delta, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, Count/PT1H/delta, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, Count/PT1H/absDelta, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, Count/PT1H/absDelta, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, Count/PT1H/percent, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200"
`;

exports[`table-query uber test all queries match snapshot 3`] = `
"
===========================================
no group by, show browser, two measures, compare PT1H, all compare types, Count/PT1H/percent, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, Count/PT1H/absPercent, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, Count/PT1H/absPercent, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/value, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/value, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/delta, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/delta, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absDelta, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absDelta, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/percent, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/percent, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absPercent, restrict never
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
no group by, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absPercent, restrict always
-----
SELECT
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
ORDER BY "Unique sessions:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by browser_version, no show, no measures, no compare, no order by
-----
SELECT "browser_version" AS "BrowserVersion"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, no measures, no compare, order by BrowserVersion
-----
SELECT "browser_version" AS "BrowserVersion"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, no measures, compare PT1H, value+delta, no order by, restrict never
-----
SELECT "browser_version" AS "BrowserVersion"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, no measures, compare PT1H, value+delta, no order by, restrict always
-----
SELECT "browser_version" AS "BrowserVersion"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, no measures, compare PT1H, value+delta, order by BrowserVersion, restrict never
-----
SELECT "browser_version" AS "BrowserVersion"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, no measures, compare PT1H, value+delta, order by BrowserVersion, restrict always
-----
SELECT "browser_version" AS "BrowserVersion"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, no measures, compare PT1H, delta+percent, no order by, restrict never
-----
SELECT "browser_version" AS "BrowserVersion"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, no measures, compare PT1H, delta+percent, no order by, restrict always
-----
SELECT "browser_version" AS "BrowserVersion"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, no measures, compare PT1H, delta+percent, order by BrowserVersion, restrict never
-----
SELECT "browser_version" AS "BrowserVersion"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, no measures, compare PT1H, delta+percent, order by BrowserVersion, restrict always
-----
SELECT "browser_version" AS "BrowserVersion"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, no measures, compare PT1H, all compare types, no order by, restrict never
-----
SELECT "browser_version" AS "BrowserVersion"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, no measures, compare PT1H, all compare types, no order by, restrict always
-----
SELECT "browser_version" AS "BrowserVersion"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, no measures, compare PT1H, all compare types, order by BrowserVersion, restrict never
-----
SELECT "browser_version" AS "BrowserVersion"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, no measures, compare PT1H, all compare types, order by BrowserVersion, restrict always
-----
SELECT "browser_version" AS "BrowserVersion"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, no compare, no order by
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, no compare, order by BrowserVersion
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, no compare, order by Count
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, value+delta, no order by, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, value+delta, no order by, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, value+delta, order by BrowserVersion, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, value+delta, order by BrowserVersion, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, value+delta, order by Count, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, value+delta, order by Count, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, value+delta, Count/PT1H/value, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, value+delta, Count/PT1H/value, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, value+delta, Count/PT1H/delta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, value+delta, Count/PT1H/delta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, delta+percent, no order by, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, delta+percent, no order by, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, delta+percent, order by BrowserVersion, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, delta+percent, order by BrowserVersion, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, delta+percent, order by Count, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, delta+percent, order by Count, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, delta+percent, Count/PT1H/delta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, delta+percent, Count/PT1H/delta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, delta+percent, Count/PT1H/percent, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, delta+percent, Count/PT1H/percent, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, all compare types, no order by, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, all compare types, no order by, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, all compare types, order by BrowserVersion, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, all compare types, order by BrowserVersion, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, all compare types, order by Count, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, all compare types, order by Count, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, all compare types, Count/PT1H/value, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, all compare types, Count/PT1H/value, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, all compare types, Count/PT1H/delta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, all compare types, Count/PT1H/delta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, all compare types, Count/PT1H/absDelta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, all compare types, Count/PT1H/absDelta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, all compare types, Count/PT1H/percent, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, all compare types, Count/PT1H/percent, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, all compare types, Count/PT1H/absPercent, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by browser_version, no show, one measure, compare PT1H, all compare types, Count/PT1H/absPercent, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, no compare, no order by
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, no compare, order by BrowserVersion
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, no compare, order by Count
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, no compare, order by Unique sessions
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, value+delta, no order by, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, value+delta, no order by, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, value+delta, order by BrowserVersion, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, value+delta, order by BrowserVersion, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, value+delta, order by Count, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, value+delta, order by Count, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, value+delta, order by Unique sessions, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, value+delta, order by Unique sessions, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, value+delta, Count/PT1H/value, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, value+delta, Count/PT1H/value, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, value+delta, Count/PT1H/delta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, value+delta, Count/PT1H/delta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, value+delta, Unique sessions/PT1H/value, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, value+delta, Unique sessions/PT1H/value, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, value+delta, Unique sessions/PT1H/delta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, value+delta, Unique sessions/PT1H/delta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, delta+percent, no order by, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, delta+percent, no order by, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, delta+percent, order by BrowserVersion, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, delta+percent, order by BrowserVersion, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, delta+percent, order by Count, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, delta+percent, order by Count, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, delta+percent, order by Unique sessions, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, delta+percent, order by Unique sessions, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, delta+percent, Count/PT1H/delta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, delta+percent, Count/PT1H/delta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, delta+percent, Count/PT1H/percent, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, delta+percent, Count/PT1H/percent, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/delta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/delta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200"
`;

exports[`table-query uber test all queries match snapshot 4`] = `
"
===========================================
group by browser_version, no show, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/percent, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/percent, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, no order by, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, no order by, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, order by BrowserVersion, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, order by BrowserVersion, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, order by Count, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, order by Count, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, order by Unique sessions, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, order by Unique sessions, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, Count/PT1H/value, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, Count/PT1H/value, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, Count/PT1H/delta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, Count/PT1H/delta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, Count/PT1H/absDelta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, Count/PT1H/absDelta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, Count/PT1H/percent, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, Count/PT1H/percent, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, Count/PT1H/absPercent, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, Count/PT1H/absPercent, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/value, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/value, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/delta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/delta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absDelta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absDelta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/percent, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/percent, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absPercent, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by browser_version, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absPercent, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by browser_version, show browser, no measures, no compare, no order by
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, no measures, no compare, order by BrowserVersion
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, no measures, no compare, order by Browser
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by browser_version, show browser, no measures, compare PT1H, value+delta, no order by, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, no measures, compare PT1H, value+delta, no order by, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, no measures, compare PT1H, value+delta, order by BrowserVersion, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, no measures, compare PT1H, value+delta, order by BrowserVersion, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, no measures, compare PT1H, value+delta, order by Browser, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by browser_version, show browser, no measures, compare PT1H, value+delta, order by Browser, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by browser_version, show browser, no measures, compare PT1H, delta+percent, no order by, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, no measures, compare PT1H, delta+percent, no order by, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, no measures, compare PT1H, delta+percent, order by BrowserVersion, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, no measures, compare PT1H, delta+percent, order by BrowserVersion, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, no measures, compare PT1H, delta+percent, order by Browser, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by browser_version, show browser, no measures, compare PT1H, delta+percent, order by Browser, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by browser_version, show browser, no measures, compare PT1H, all compare types, no order by, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, no measures, compare PT1H, all compare types, no order by, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, no measures, compare PT1H, all compare types, order by BrowserVersion, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, no measures, compare PT1H, all compare types, order by BrowserVersion, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, no measures, compare PT1H, all compare types, order by Browser, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by browser_version, show browser, no measures, compare PT1H, all compare types, order by Browser, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, no compare, no order by
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, no compare, order by BrowserVersion
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, no compare, order by Browser
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, no compare, order by Count
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, value+delta, no order by, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, value+delta, no order by, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, value+delta, order by BrowserVersion, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, value+delta, order by BrowserVersion, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, value+delta, order by Browser, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, value+delta, order by Browser, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, value+delta, order by Count, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, value+delta, order by Count, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, value+delta, Count/PT1H/value, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, value+delta, Count/PT1H/value, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, value+delta, Count/PT1H/delta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, value+delta, Count/PT1H/delta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, delta+percent, no order by, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, delta+percent, no order by, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, delta+percent, order by BrowserVersion, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, delta+percent, order by BrowserVersion, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, delta+percent, order by Browser, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, delta+percent, order by Browser, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, delta+percent, order by Count, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, delta+percent, order by Count, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, delta+percent, Count/PT1H/delta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, delta+percent, Count/PT1H/delta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, delta+percent, Count/PT1H/percent, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, delta+percent, Count/PT1H/percent, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, all compare types, no order by, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, all compare types, no order by, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, all compare types, order by BrowserVersion, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, all compare types, order by BrowserVersion, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, all compare types, order by Browser, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, all compare types, order by Browser, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, all compare types, order by Count, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, all compare types, order by Count, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, all compare types, Count/PT1H/value, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, all compare types, Count/PT1H/value, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, all compare types, Count/PT1H/delta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, all compare types, Count/PT1H/delta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, all compare types, Count/PT1H/absDelta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, all compare types, Count/PT1H/absDelta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, all compare types, Count/PT1H/percent, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, all compare types, Count/PT1H/percent, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, all compare types, Count/PT1H/absPercent, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by browser_version, show browser, one measure, compare PT1H, all compare types, Count/PT1H/absPercent, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, no compare, no order by
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, no compare, order by BrowserVersion
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, no compare, order by Browser
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200"
`;

exports[`table-query uber test all queries match snapshot 5`] = `
"
===========================================
group by browser_version, show browser, two measures, no compare, order by Count
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, no compare, order by Unique sessions
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, value+delta, no order by, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, value+delta, no order by, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, value+delta, order by BrowserVersion, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, value+delta, order by BrowserVersion, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, value+delta, order by Browser, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, value+delta, order by Browser, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, value+delta, order by Count, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, value+delta, order by Count, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, value+delta, order by Unique sessions, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, value+delta, order by Unique sessions, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, value+delta, Count/PT1H/value, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, value+delta, Count/PT1H/value, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, value+delta, Count/PT1H/delta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, value+delta, Count/PT1H/delta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, value+delta, Unique sessions/PT1H/value, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, value+delta, Unique sessions/PT1H/value, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, value+delta, Unique sessions/PT1H/delta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, value+delta, Unique sessions/PT1H/delta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, delta+percent, no order by, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, delta+percent, no order by, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, delta+percent, order by BrowserVersion, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, delta+percent, order by BrowserVersion, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, delta+percent, order by Browser, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, delta+percent, order by Browser, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, delta+percent, order by Count, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, delta+percent, order by Count, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, delta+percent, order by Unique sessions, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, delta+percent, order by Unique sessions, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, delta+percent, Count/PT1H/delta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, delta+percent, Count/PT1H/delta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, delta+percent, Count/PT1H/percent, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, delta+percent, Count/PT1H/percent, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/delta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/delta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/percent, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/percent, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, no order by, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, no order by, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, order by BrowserVersion, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, order by BrowserVersion, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, order by Browser, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, order by Browser, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, order by Count, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, order by Count, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, order by Unique sessions, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, order by Unique sessions, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, Count/PT1H/value, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, Count/PT1H/value, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, Count/PT1H/delta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, Count/PT1H/delta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, Count/PT1H/absDelta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, Count/PT1H/absDelta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, Count/PT1H/percent, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, Count/PT1H/percent, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, Count/PT1H/absPercent, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, Count/PT1H/absPercent, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/value, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/value, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/delta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/delta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absDelta, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absDelta, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/percent, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/percent, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absPercent, restrict never
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by browser_version, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absPercent, restrict always
-----
SELECT
  "browser_version" AS "BrowserVersion",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by __time, no show, no measures, no compare, no order by
-----
SELECT TIME_FLOOR("__time", 'PT1H') AS "__time"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, no measures, no compare, order by __time
-----
SELECT TIME_FLOOR("__time", 'PT1H') AS "__time"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, no measures, compare PT1H, value+delta, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, no measures, compare PT1H, value+delta, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, no measures, compare PT1H, value+delta, order by __time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, no measures, compare PT1H, value+delta, order by __time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, no measures, compare PT1H, delta+percent, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, no measures, compare PT1H, delta+percent, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, no measures, compare PT1H, delta+percent, order by __time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, no measures, compare PT1H, delta+percent, order by __time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, no measures, compare PT1H, all compare types, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, no measures, compare PT1H, all compare types, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, no measures, compare PT1H, all compare types, order by __time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, no measures, compare PT1H, all compare types, order by __time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, no compare, no order by
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "__time",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, no compare, order by __time
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "__time",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, no compare, order by Count
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "__time",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, value+delta, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, value+delta, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, value+delta, order by __time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, value+delta, order by __time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, value+delta, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, value+delta, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, value+delta, Count/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, value+delta, Count/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, value+delta, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, value+delta, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, delta+percent, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, delta+percent, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, delta+percent, order by __time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, delta+percent, order by __time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, delta+percent, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200"
`;

exports[`table-query uber test all queries match snapshot 6`] = `
"
===========================================
group by __time, no show, one measure, compare PT1H, delta+percent, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, delta+percent, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, delta+percent, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, delta+percent, Count/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, delta+percent, Count/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, all compare types, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, all compare types, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, all compare types, order by __time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, all compare types, order by __time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, all compare types, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, all compare types, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, all compare types, Count/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, all compare types, Count/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, all compare types, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, all compare types, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, all compare types, Count/PT1H/absDelta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, all compare types, Count/PT1H/absDelta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, all compare types, Count/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, all compare types, Count/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, all compare types, Count/PT1H/absPercent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by __time, no show, one measure, compare PT1H, all compare types, Count/PT1H/absPercent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, no compare, no order by
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "__time",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, no compare, order by __time
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "__time",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, no compare, order by Count
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "__time",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, no compare, order by Unique sessions
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "__time",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, value+delta, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, value+delta, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, value+delta, order by __time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, value+delta, order by __time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, value+delta, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, value+delta, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, value+delta, order by Unique sessions, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, value+delta, order by Unique sessions, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, value+delta, Count/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, value+delta, Count/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, value+delta, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, value+delta, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, value+delta, Unique sessions/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, value+delta, Unique sessions/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, value+delta, Unique sessions/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, value+delta, Unique sessions/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, delta+percent, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, delta+percent, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, delta+percent, order by __time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, delta+percent, order by __time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, delta+percent, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, delta+percent, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, delta+percent, order by Unique sessions, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, delta+percent, order by Unique sessions, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, delta+percent, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, delta+percent, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, delta+percent, Count/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, delta+percent, Count/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, order by __time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, order by __time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, order by Unique sessions, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, order by Unique sessions, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, Count/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, Count/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, Count/PT1H/absDelta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, Count/PT1H/absDelta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, Count/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, Count/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, Count/PT1H/absPercent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, Count/PT1H/absPercent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absDelta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absDelta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absPercent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by __time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absPercent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by __time, show browser, no measures, no compare, no order by
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "__time",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, no measures, no compare, order by __time
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "__time",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, no measures, no compare, order by Browser
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "__time",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by __time, show browser, no measures, compare PT1H, value+delta, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, no measures, compare PT1H, value+delta, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, no measures, compare PT1H, value+delta, order by __time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, no measures, compare PT1H, value+delta, order by __time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, no measures, compare PT1H, value+delta, order by Browser, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Browser" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Browser" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by __time, show browser, no measures, compare PT1H, value+delta, order by Browser, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by __time, show browser, no measures, compare PT1H, delta+percent, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, no measures, compare PT1H, delta+percent, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, no measures, compare PT1H, delta+percent, order by __time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, no measures, compare PT1H, delta+percent, order by __time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, no measures, compare PT1H, delta+percent, order by Browser, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Browser" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Browser" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by __time, show browser, no measures, compare PT1H, delta+percent, order by Browser, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200"
`;

exports[`table-query uber test all queries match snapshot 7`] = `
"
===========================================
group by __time, show browser, no measures, compare PT1H, all compare types, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, no measures, compare PT1H, all compare types, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, no measures, compare PT1H, all compare types, order by __time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, no measures, compare PT1H, all compare types, order by __time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, no measures, compare PT1H, all compare types, order by Browser, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Browser" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Browser" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by __time, show browser, no measures, compare PT1H, all compare types, order by Browser, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, no compare, no order by
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "__time",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, no compare, order by __time
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "__time",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, no compare, order by Browser
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "__time",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, no compare, order by Count
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "__time",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, value+delta, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, value+delta, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, value+delta, order by __time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, value+delta, order by __time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, value+delta, order by Browser, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Browser" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Browser" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, value+delta, order by Browser, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, value+delta, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, value+delta, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, value+delta, Count/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, value+delta, Count/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, value+delta, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, value+delta, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, delta+percent, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, delta+percent, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, delta+percent, order by __time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, delta+percent, order by __time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, delta+percent, order by Browser, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Browser" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Browser" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, delta+percent, order by Browser, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, delta+percent, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, delta+percent, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, delta+percent, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, delta+percent, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, delta+percent, Count/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, delta+percent, Count/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, all compare types, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, all compare types, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, all compare types, order by __time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, all compare types, order by __time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, all compare types, order by Browser, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Browser" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Browser" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, all compare types, order by Browser, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, all compare types, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, all compare types, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/absDelta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/absDelta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/absPercent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by __time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/absPercent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, no compare, no order by
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "__time",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, no compare, order by __time
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "__time",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, no compare, order by Browser
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "__time",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, no compare, order by Count
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "__time",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, no compare, order by Unique sessions
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "__time",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, value+delta, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, value+delta, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, value+delta, order by __time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, value+delta, order by __time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, value+delta, order by Browser, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Browser" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Browser" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, value+delta, order by Browser, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, value+delta, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, value+delta, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, value+delta, order by Unique sessions, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, value+delta, order by Unique sessions, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, value+delta, Count/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, value+delta, Count/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, value+delta, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, value+delta, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, value+delta, Unique sessions/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, value+delta, Unique sessions/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, value+delta, Unique sessions/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, value+delta, Unique sessions/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, delta+percent, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, delta+percent, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, delta+percent, order by __time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, delta+percent, order by __time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, delta+percent, order by Browser, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Browser" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Browser" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, delta+percent, order by Browser, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, delta+percent, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, delta+percent, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, delta+percent, order by Unique sessions, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, delta+percent, order by Unique sessions, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, delta+percent, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, delta+percent, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, delta+percent, Count/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, delta+percent, Count/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, order by __time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "__time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, order by __time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "__time" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, order by Browser, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Browser" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Browser" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, order by Browser, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200"
`;

exports[`table-query uber test all queries match snapshot 8`] = `
"
===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, order by Unique sessions, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, order by Unique sessions, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/absDelta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/absDelta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/absPercent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/absPercent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absDelta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absDelta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absPercent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by __time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absPercent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT TIME_FLOOR("t"."__time", 'PT1H') AS "__time"
  FROM "common" AS "t"
  GROUP BY 1
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "__time",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."__time"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1
)
SELECT
  COALESCE("main"."__time", "compare_PT1H"."__time") AS "__time",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."__time" IS NOT DISTINCT FROM "compare_PT1H"."__time"
GROUP BY 1
ORDER BY "Unique sessions:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things without time, no show, no measures, no compare, no order by
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, no measures, no compare, order by BrowserVersion
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, no measures, no compare, order by country
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, no show, no measures, compare PT1H, value+delta, no order by, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, no measures, compare PT1H, value+delta, no order by, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, no measures, compare PT1H, value+delta, order by BrowserVersion, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, no measures, compare PT1H, value+delta, order by BrowserVersion, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, no measures, compare PT1H, value+delta, order by country, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, no show, no measures, compare PT1H, value+delta, order by country, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, no show, no measures, compare PT1H, delta+percent, no order by, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, no measures, compare PT1H, delta+percent, no order by, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, no measures, compare PT1H, delta+percent, order by BrowserVersion, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, no measures, compare PT1H, delta+percent, order by BrowserVersion, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, no measures, compare PT1H, delta+percent, order by country, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, no show, no measures, compare PT1H, delta+percent, order by country, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, no show, no measures, compare PT1H, all compare types, no order by, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, no measures, compare PT1H, all compare types, no order by, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, no measures, compare PT1H, all compare types, order by BrowserVersion, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, no measures, compare PT1H, all compare types, order by BrowserVersion, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, no measures, compare PT1H, all compare types, order by country, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, no show, no measures, compare PT1H, all compare types, order by country, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, no compare, no order by
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, no compare, order by BrowserVersion
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, no compare, order by country
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, no compare, order by Count
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, value+delta, no order by, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, value+delta, no order by, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, value+delta, order by BrowserVersion, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, value+delta, order by BrowserVersion, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, value+delta, order by country, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, value+delta, order by country, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, value+delta, order by Count, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, value+delta, order by Count, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, value+delta, Count/PT1H/value, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, value+delta, Count/PT1H/value, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, value+delta, Count/PT1H/delta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, value+delta, Count/PT1H/delta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, delta+percent, no order by, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, delta+percent, no order by, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, delta+percent, order by BrowserVersion, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, delta+percent, order by BrowserVersion, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, delta+percent, order by country, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, delta+percent, order by country, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, delta+percent, order by Count, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, delta+percent, order by Count, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, delta+percent, Count/PT1H/delta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, delta+percent, Count/PT1H/delta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, delta+percent, Count/PT1H/percent, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, delta+percent, Count/PT1H/percent, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, all compare types, no order by, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, all compare types, no order by, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, all compare types, order by BrowserVersion, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, all compare types, order by BrowserVersion, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, all compare types, order by country, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, all compare types, order by country, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, all compare types, order by Count, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, all compare types, order by Count, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, all compare types, Count/PT1H/value, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, all compare types, Count/PT1H/value, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, all compare types, Count/PT1H/delta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, all compare types, Count/PT1H/delta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, all compare types, Count/PT1H/absDelta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, all compare types, Count/PT1H/absDelta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, all compare types, Count/PT1H/percent, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, all compare types, Count/PT1H/percent, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, all compare types, Count/PT1H/absPercent, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things without time, no show, one measure, compare PT1H, all compare types, Count/PT1H/absPercent, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, no compare, no order by
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, no compare, order by BrowserVersion
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, no compare, order by country
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, no compare, order by Count
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, no compare, order by Unique sessions
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, value+delta, no order by, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, value+delta, no order by, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, value+delta, order by BrowserVersion, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, value+delta, order by BrowserVersion, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, value+delta, order by country, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200"
`;

exports[`table-query uber test all queries match snapshot 9`] = `
"
===========================================
group by several things without time, no show, two measures, compare PT1H, value+delta, order by country, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, value+delta, order by Count, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, value+delta, order by Count, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, value+delta, order by Unique sessions, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, value+delta, order by Unique sessions, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, value+delta, Count/PT1H/value, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, value+delta, Count/PT1H/value, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, value+delta, Count/PT1H/delta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, value+delta, Count/PT1H/delta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, value+delta, Unique sessions/PT1H/value, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, value+delta, Unique sessions/PT1H/value, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, value+delta, Unique sessions/PT1H/delta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, value+delta, Unique sessions/PT1H/delta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, delta+percent, no order by, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, delta+percent, no order by, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, delta+percent, order by BrowserVersion, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, delta+percent, order by BrowserVersion, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, delta+percent, order by country, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, delta+percent, order by country, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, delta+percent, order by Count, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, delta+percent, order by Count, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, delta+percent, order by Unique sessions, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, delta+percent, order by Unique sessions, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, delta+percent, Count/PT1H/delta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, delta+percent, Count/PT1H/delta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, delta+percent, Count/PT1H/percent, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, delta+percent, Count/PT1H/percent, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/delta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/delta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/percent, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/percent, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, no order by, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, no order by, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, order by BrowserVersion, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, order by BrowserVersion, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, order by country, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, order by country, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, order by Count, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, order by Count, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, order by Unique sessions, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, order by Unique sessions, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, Count/PT1H/value, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, Count/PT1H/value, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, Count/PT1H/delta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, Count/PT1H/delta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, Count/PT1H/absDelta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, Count/PT1H/absDelta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, Count/PT1H/percent, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, Count/PT1H/percent, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, Count/PT1H/absPercent, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, Count/PT1H/absPercent, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/value, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/value, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/delta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/delta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absDelta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absDelta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/percent, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/percent, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absPercent, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things without time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absPercent, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, no compare, no order by
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, no compare, order by BrowserVersion
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, no compare, order by country
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, no compare, order by Browser
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, value+delta, no order by, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, value+delta, no order by, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, value+delta, order by BrowserVersion, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, value+delta, order by BrowserVersion, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, value+delta, order by country, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, value+delta, order by country, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, value+delta, order by Browser, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, value+delta, order by Browser, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, delta+percent, no order by, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, delta+percent, no order by, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, delta+percent, order by BrowserVersion, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, delta+percent, order by BrowserVersion, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, delta+percent, order by country, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, delta+percent, order by country, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, delta+percent, order by Browser, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, delta+percent, order by Browser, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, all compare types, no order by, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, all compare types, no order by, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, all compare types, order by BrowserVersion, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, all compare types, order by BrowserVersion, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, all compare types, order by country, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, all compare types, order by country, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, all compare types, order by Browser, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things without time, show browser, no measures, compare PT1H, all compare types, order by Browser, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, no compare, no order by
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, no compare, order by BrowserVersion
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, no compare, order by country
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, no compare, order by Browser
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, no compare, order by Count
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, value+delta, no order by, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, value+delta, no order by, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, value+delta, order by BrowserVersion, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, value+delta, order by BrowserVersion, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, value+delta, order by country, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, value+delta, order by country, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200"
`;

exports[`table-query uber test all queries match snapshot 10`] = `
"
===========================================
group by several things without time, show browser, one measure, compare PT1H, value+delta, order by Browser, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, value+delta, order by Browser, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, value+delta, order by Count, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, value+delta, order by Count, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, value+delta, Count/PT1H/value, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, value+delta, Count/PT1H/value, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, value+delta, Count/PT1H/delta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, value+delta, Count/PT1H/delta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, delta+percent, no order by, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, delta+percent, no order by, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, delta+percent, order by BrowserVersion, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, delta+percent, order by BrowserVersion, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, delta+percent, order by country, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, delta+percent, order by country, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, delta+percent, order by Browser, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, delta+percent, order by Browser, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, delta+percent, order by Count, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, delta+percent, order by Count, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, delta+percent, Count/PT1H/delta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, delta+percent, Count/PT1H/delta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, delta+percent, Count/PT1H/percent, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, delta+percent, Count/PT1H/percent, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, all compare types, no order by, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, all compare types, no order by, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, all compare types, order by BrowserVersion, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, all compare types, order by BrowserVersion, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, all compare types, order by country, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, all compare types, order by country, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, all compare types, order by Browser, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, all compare types, order by Browser, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, all compare types, order by Count, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, all compare types, order by Count, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/value, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/value, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/delta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/delta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/absDelta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/absDelta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/percent, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/percent, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/absPercent, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things without time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/absPercent, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, no compare, no order by
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, no compare, order by BrowserVersion
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, no compare, order by country
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, no compare, order by Browser
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, no compare, order by Count
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, no compare, order by Unique sessions
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, value+delta, no order by, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, value+delta, no order by, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, value+delta, order by BrowserVersion, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, value+delta, order by BrowserVersion, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, value+delta, order by country, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, value+delta, order by country, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, value+delta, order by Browser, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, value+delta, order by Browser, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, value+delta, order by Count, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, value+delta, order by Count, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, value+delta, order by Unique sessions, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, value+delta, order by Unique sessions, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, value+delta, Count/PT1H/value, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, value+delta, Count/PT1H/value, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, value+delta, Count/PT1H/delta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, value+delta, Count/PT1H/delta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, value+delta, Unique sessions/PT1H/value, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, value+delta, Unique sessions/PT1H/value, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, value+delta, Unique sessions/PT1H/delta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, value+delta, Unique sessions/PT1H/delta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, delta+percent, no order by, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, delta+percent, no order by, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, delta+percent, order by BrowserVersion, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, delta+percent, order by BrowserVersion, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, delta+percent, order by country, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, delta+percent, order by country, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, delta+percent, order by Browser, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, delta+percent, order by Browser, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, delta+percent, order by Count, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, delta+percent, order by Count, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, delta+percent, order by Unique sessions, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, delta+percent, order by Unique sessions, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, delta+percent, Count/PT1H/delta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, delta+percent, Count/PT1H/delta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, delta+percent, Count/PT1H/percent, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, delta+percent, Count/PT1H/percent, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/delta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/delta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/percent, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/percent, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, no order by, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, no order by, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, order by BrowserVersion, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, order by BrowserVersion, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, order by country, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, order by country, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, order by Browser, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, order by Browser, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, order by Count, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, order by Count, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, order by Unique sessions, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, order by Unique sessions, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions" DESC
LIMIT 200"
`;

exports[`table-query uber test all queries match snapshot 11`] = `
"
===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/value, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/value, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/delta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/delta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/absDelta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/absDelta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/percent, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/percent, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/absPercent, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/absPercent, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/value, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/value, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/delta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/delta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absDelta, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absDelta, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/percent, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/percent, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absPercent, restrict never
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things without time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absPercent, restrict always
-----
SELECT
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Count",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) AS "Unique sessions",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:value",
  COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(*) FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00'), 0) - COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0) AS DOUBLE), COALESCE(COUNT(DISTINCT "session") FILTER (WHERE TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1)), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1) <= "__time" AND "__time" < TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1))) AND "country" = 'United States'
GROUP BY 1, 2
ORDER BY "Unique sessions:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, no compare, no order by
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, no compare, order by Time
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, no compare, order by BrowserVersion
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, no compare, order by country
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, value+delta, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, value+delta, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, value+delta, order by Time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, value+delta, order by Time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, value+delta, order by BrowserVersion, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, value+delta, order by BrowserVersion, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY LOWER(browser_version) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, value+delta, order by country, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, value+delta, order by country, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, delta+percent, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, delta+percent, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, delta+percent, order by Time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, delta+percent, order by Time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, delta+percent, order by BrowserVersion, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, delta+percent, order by BrowserVersion, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY LOWER(browser_version) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, delta+percent, order by country, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, delta+percent, order by country, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, all compare types, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, all compare types, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, all compare types, order by Time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, all compare types, order by Time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, all compare types, order by BrowserVersion, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, all compare types, order by BrowserVersion, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY LOWER(browser_version) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, all compare types, order by country, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, no show, no measures, compare PT1H, all compare types, order by country, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, no compare, no order by
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, no compare, order by Time
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, no compare, order by BrowserVersion
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, no compare, order by country
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, no compare, order by Count
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, value+delta, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, value+delta, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, value+delta, order by Time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, value+delta, order by Time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, value+delta, order by BrowserVersion, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, value+delta, order by BrowserVersion, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY LOWER(browser_version) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, value+delta, order by country, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, value+delta, order by country, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, value+delta, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, value+delta, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, value+delta, Count/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, value+delta, Count/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, value+delta, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, value+delta, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, delta+percent, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, delta+percent, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, delta+percent, order by Time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, delta+percent, order by Time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, delta+percent, order by BrowserVersion, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, delta+percent, order by BrowserVersion, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY LOWER(browser_version) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, delta+percent, order by country, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, delta+percent, order by country, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, delta+percent, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, delta+percent, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, delta+percent, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, delta+percent, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, delta+percent, Count/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, delta+percent, Count/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, all compare types, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, all compare types, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, all compare types, order by Time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, all compare types, order by Time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, all compare types, order by BrowserVersion, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, all compare types, order by BrowserVersion, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY LOWER(browser_version) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, all compare types, order by country, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, all compare types, order by country, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, all compare types, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, all compare types, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, all compare types, Count/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, all compare types, Count/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, all compare types, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, all compare types, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, all compare types, Count/PT1H/absDelta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, all compare types, Count/PT1H/absDelta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, all compare types, Count/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, all compare types, Count/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, no show, one measure, compare PT1H, all compare types, Count/PT1H/absPercent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200"
`;

exports[`table-query uber test all queries match snapshot 12`] = `
"
===========================================
group by several things and time, no show, one measure, compare PT1H, all compare types, Count/PT1H/absPercent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, no compare, no order by
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, no compare, order by Time
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, no compare, order by BrowserVersion
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, no compare, order by country
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, no compare, order by Count
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, no compare, order by Unique sessions
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, value+delta, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, value+delta, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, value+delta, order by Time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, value+delta, order by Time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, value+delta, order by BrowserVersion, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, value+delta, order by BrowserVersion, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY LOWER(browser_version) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, value+delta, order by country, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, value+delta, order by country, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, value+delta, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, value+delta, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, value+delta, order by Unique sessions, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, value+delta, order by Unique sessions, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, value+delta, Count/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, value+delta, Count/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, value+delta, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, value+delta, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, value+delta, Unique sessions/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, value+delta, Unique sessions/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, value+delta, Unique sessions/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, value+delta, Unique sessions/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, delta+percent, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, delta+percent, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, delta+percent, order by Time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, delta+percent, order by Time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, delta+percent, order by BrowserVersion, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, delta+percent, order by BrowserVersion, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY LOWER(browser_version) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, delta+percent, order by country, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, delta+percent, order by country, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, delta+percent, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, delta+percent, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, delta+percent, order by Unique sessions, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, delta+percent, order by Unique sessions, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, delta+percent, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, delta+percent, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, delta+percent, Count/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, delta+percent, Count/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, order by Time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, order by Time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, order by BrowserVersion, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, order by BrowserVersion, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY LOWER(browser_version) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, order by country, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, order by country, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, order by Unique sessions, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, order by Unique sessions, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, Count/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, Count/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, Count/PT1H/absDelta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, Count/PT1H/absDelta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, Count/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, Count/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, Count/PT1H/absPercent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, Count/PT1H/absPercent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absDelta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absDelta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absPercent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things and time, no show, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absPercent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, no compare, no order by
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, no compare, order by Time
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, no compare, order by BrowserVersion
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, no compare, order by country
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, no compare, order by Browser
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, value+delta, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, value+delta, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, value+delta, order by Time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, value+delta, order by Time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, value+delta, order by BrowserVersion, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, value+delta, order by BrowserVersion, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY LOWER(browser_version) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, value+delta, order by country, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, value+delta, order by country, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, value+delta, order by Browser, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Browser" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Browser" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, value+delta, order by Browser, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, delta+percent, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, delta+percent, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, delta+percent, order by Time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, delta+percent, order by Time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, delta+percent, order by BrowserVersion, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, delta+percent, order by BrowserVersion, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY LOWER(browser_version) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200"
`;

exports[`table-query uber test all queries match snapshot 13`] = `
"
===========================================
group by several things and time, show browser, no measures, compare PT1H, delta+percent, order by country, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, delta+percent, order by country, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, delta+percent, order by Browser, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Browser" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Browser" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, delta+percent, order by Browser, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, all compare types, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, all compare types, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, all compare types, order by Time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, all compare types, order by Time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, all compare types, order by BrowserVersion, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, all compare types, order by BrowserVersion, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY LOWER(browser_version) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, all compare types, order by country, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, all compare types, order by country, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, all compare types, order by Browser, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Browser" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Browser" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things and time, show browser, no measures, compare PT1H, all compare types, order by Browser, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, no compare, no order by
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, no compare, order by Time
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, no compare, order by BrowserVersion
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, no compare, order by country
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, no compare, order by Browser
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, no compare, order by Count
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, value+delta, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, value+delta, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, value+delta, order by Time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, value+delta, order by Time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, value+delta, order by BrowserVersion, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, value+delta, order by BrowserVersion, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY LOWER(browser_version) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, value+delta, order by country, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, value+delta, order by country, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, value+delta, order by Browser, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Browser" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Browser" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, value+delta, order by Browser, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, value+delta, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, value+delta, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, value+delta, Count/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, value+delta, Count/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, value+delta, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, value+delta, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, delta+percent, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, delta+percent, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, delta+percent, order by Time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, delta+percent, order by Time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, delta+percent, order by BrowserVersion, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, delta+percent, order by BrowserVersion, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY LOWER(browser_version) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, delta+percent, order by country, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, delta+percent, order by country, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, delta+percent, order by Browser, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Browser" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Browser" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, delta+percent, order by Browser, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, delta+percent, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, delta+percent, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, delta+percent, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, delta+percent, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, delta+percent, Count/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, delta+percent, Count/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, all compare types, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, all compare types, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, all compare types, order by Time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, all compare types, order by Time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, all compare types, order by BrowserVersion, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, all compare types, order by BrowserVersion, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY LOWER(browser_version) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, all compare types, order by country, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, all compare types, order by country, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, all compare types, order by Browser, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Browser" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Browser" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, all compare types, order by Browser, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, all compare types, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, all compare types, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/absDelta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/absDelta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/absPercent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things and time, show browser, one measure, compare PT1H, all compare types, Count/PT1H/absPercent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, no compare, no order by
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, no compare, order by Time
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, no compare, order by BrowserVersion
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, no compare, order by country
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, no compare, order by Browser
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, no compare, order by Count
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, no compare, order by Unique sessions
-----
SELECT
  TIME_FLOOR("__time", 'PT1H') AS "Time",
  LOWER(browser_version) AS "BrowserVersion",
  "country" AS "country",
  CASE WHEN COUNT(DISTINCT "browser") = 1 THEN LATEST_BY("browser", "__time") ELSE NULL END AS "Browser",
  COUNT(*) AS "Count",
  COUNT(DISTINCT "session") AS "Unique sessions"
FROM (
  SELECT *
  FROM "kttm"
) AS "t"
WHERE (TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "__time" AND "__time" < TIMESTAMP '2019-08-25 14:20:00') AND "country" = 'United States'
GROUP BY 1, 2, 3
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, value+delta, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, value+delta, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, value+delta, order by Time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, value+delta, order by Time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, value+delta, order by BrowserVersion, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, value+delta, order by BrowserVersion, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY LOWER(browser_version) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, value+delta, order by country, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, value+delta, order by country, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, value+delta, order by Browser, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Browser" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Browser" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, value+delta, order by Browser, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, value+delta, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, value+delta, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, value+delta, order by Unique sessions, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, value+delta, order by Unique sessions, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, value+delta, Count/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, value+delta, Count/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, value+delta, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, value+delta, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, value+delta, Unique sessions/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200"
`;

exports[`table-query uber test all queries match snapshot 14`] = `
"
===========================================
group by several things and time, show browser, two measures, compare PT1H, value+delta, Unique sessions/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, value+delta, Unique sessions/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, value+delta, Unique sessions/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, delta+percent, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, delta+percent, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, delta+percent, order by Time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, delta+percent, order by Time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, delta+percent, order by BrowserVersion, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, delta+percent, order by BrowserVersion, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY LOWER(browser_version) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, delta+percent, order by country, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, delta+percent, order by country, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, delta+percent, order by Browser, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Browser" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Browser" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, delta+percent, order by Browser, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, delta+percent, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, delta+percent, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, delta+percent, order by Unique sessions, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, delta+percent, order by Unique sessions, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, delta+percent, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, delta+percent, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, delta+percent, Count/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, delta+percent, Count/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, delta+percent, Unique sessions/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, no order by, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, no order by, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, order by Time, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Time" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, order by Time, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY TIME_FLOOR("__time", 'PT1H') DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Time" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, order by BrowserVersion, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "BrowserVersion" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, order by BrowserVersion, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY LOWER(browser_version) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "BrowserVersion" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, order by country, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, order by country, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY "country" DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "country" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, order by Browser, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Browser" DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Browser" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, order by Browser, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Browser" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, order by Count, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, order by Count, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, order by Unique sessions, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, order by Unique sessions, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 200
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/absDelta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/absDelta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/absPercent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Count" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, Count/PT1H/absPercent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(*) DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Count:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/value, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/value, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 200
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:value" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/delta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/delta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:delta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absDelta, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absDelta, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:absDelta" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/percent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/percent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:percent" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absPercent, restrict never
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 50000
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
  ORDER BY "Unique sessions" DESC
  LIMIT 50000
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:absPercent" DESC
LIMIT 200

===========================================
group by several things and time, show browser, two measures, compare PT1H, all compare types, Unique sessions/PT1H/absPercent, restrict always
-----
WITH
"common" AS (
  SELECT *
  FROM (
    SELECT *
    FROM "kttm"
  ) AS "t"
  WHERE ((TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00') OR (TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H'))) AND "t"."country" = 'United States'
),
"top_values" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country"
  FROM "common" AS "t"
  GROUP BY 1, 2, 3
  ORDER BY COUNT(DISTINCT "session") DESC
  LIMIT 5000
),
"main" AS (
  SELECT
    TIME_FLOOR("t"."__time", 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR("t"."__time", 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1) <= "t"."__time" AND "t"."__time" < TIMESTAMP '2019-08-25 14:20:00'
  GROUP BY 1, 2, 3
),
"compare_PT1H" AS (
  SELECT
    TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') AS "Time",
    LOWER("t".browser_version) AS "BrowserVersion",
    "t"."country" AS "country",
    CASE WHEN COUNT(DISTINCT "t"."browser") = 1 THEN LATEST_BY("t"."browser", "t"."__time") ELSE NULL END AS "Browser",
    COUNT(*) AS "Count",
    COUNT(DISTINCT "session") AS "Unique sessions"
  FROM "common" AS "t"
  INNER JOIN "top_values" ON TIME_FLOOR(TIME_SHIFT("t"."__time", 'PT1H', 1), 'PT1H') IS NOT DISTINCT FROM "top_values"."Time" AND LOWER("t".browser_version) IS NOT DISTINCT FROM "top_values"."BrowserVersion" AND "t"."country" IS NOT DISTINCT FROM "top_values"."country"
  WHERE TIME_FLOOR(TIME_SHIFT(TIME_SHIFT(TIMESTAMP '2019-08-25 08:20:00', 'PT1H', -1), 'PT1H', -1), 'PT1H') <= "t"."__time" AND "t"."__time" < TIME_CEIL(TIME_SHIFT(TIMESTAMP '2019-08-25 14:20:00', 'PT1H', -1), 'PT1H')
  GROUP BY 1, 2, 3
)
SELECT
  COALESCE("main"."Time", "compare_PT1H"."Time") AS "Time",
  COALESCE("main"."BrowserVersion", "compare_PT1H"."BrowserVersion") AS "BrowserVersion",
  COALESCE("main"."country", "compare_PT1H"."country") AS "country",
  COALESCE(ANY_VALUE("main"."Browser"), ANY_VALUE("compare_PT1H"."Browser")) AS "Browser",
  COALESCE(ANY_VALUE("main"."Count"), 0) AS "Count",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) AS "Unique sessions",
  COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS "Count:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)) AS "Count:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0) AS "Count:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Count"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Count"), 0)), 0)) AS "Count:compare:PT1H:absPercent",
  COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:value",
  COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS "Unique sessions:compare:PT1H:delta",
  ABS(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)) AS "Unique sessions:compare:PT1H:absDelta",
  COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0) AS "Unique sessions:compare:PT1H:percent",
  ABS(COALESCE(SAFE_DIVIDE(CAST(COALESCE(ANY_VALUE("main"."Unique sessions"), 0) - COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0) AS DOUBLE), COALESCE(ANY_VALUE("compare_PT1H"."Unique sessions"), 0)), 0)) AS "Unique sessions:compare:PT1H:absPercent"
FROM "main"
FULL JOIN "compare_PT1H" ON "main"."Time" IS NOT DISTINCT FROM "compare_PT1H"."Time" AND "main"."BrowserVersion" IS NOT DISTINCT FROM "compare_PT1H"."BrowserVersion" AND "main"."country" IS NOT DISTINCT FROM "compare_PT1H"."country"
GROUP BY 1, 2, 3
ORDER BY "Unique sessions:compare:PT1H:absPercent" DESC
LIMIT 200"
`;
