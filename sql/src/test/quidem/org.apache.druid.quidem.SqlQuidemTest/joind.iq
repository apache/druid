!use druidtest://?numMergeBuffers=3
!set outputformat mysql

with t1 as (
select * from foo, unnest(MV_TO_ARRAY("dim3")) as u(d3)
)
select t1.dim3, t1.d3, t2.dim2 from t1 JOIN t1 as t2
ON t1.d3 = t2.d3;
+-----------+----+------+
| dim3      | d3 | dim2 |
+-----------+----+------+
|           |    | a    |
| ["a","b"] | a  | a    |
| ["a","b"] | b  | a    |
| ["a","b"] | b  |      |
| ["b","c"] | b  | a    |
| ["b","c"] | b  |      |
| ["b","c"] | c  |      |
| d         | d  |      |
+-----------+----+------+
(8 rows)

!ok


select * from foo, unnest(MV_TO_ARRAY("dim3")) as u(d3);
+-------------------------+------+------+-----------+-----+-----+-----+--------------------+----+
| __time                  | dim1 | dim2 | dim3      | cnt | m1  | m2  | unique_dim1        | d3 |
+-------------------------+------+------+-----------+-----+-----+-----+--------------------+----+
| 2000-01-01 00:00:00.000 |      | a    | ["a","b"] |   1 | 1.0 | 1.0 | "AQAAAEAAAA=="     | a  |
| 2000-01-01 00:00:00.000 |      | a    | ["a","b"] |   1 | 1.0 | 1.0 | "AQAAAEAAAA=="     | b  |
| 2000-01-02 00:00:00.000 | 10.1 |      | ["b","c"] |   1 | 2.0 | 2.0 | "AQAAAQAAAAHNBA==" | b  |
| 2000-01-02 00:00:00.000 | 10.1 |      | ["b","c"] |   1 | 2.0 | 2.0 | "AQAAAQAAAAHNBA==" | c  |
| 2000-01-03 00:00:00.000 | 2    |      | d         |   1 | 3.0 | 3.0 | "AQAAAQAAAAOzAg==" | d  |
| 2001-01-01 00:00:00.000 | 1    | a    |           |   1 | 4.0 | 4.0 | "AQAAAQAAAAFREA==" |    |
| 2001-01-02 00:00:00.000 | def  | abc  |           |   1 | 5.0 | 5.0 | "AQAAAQAAAACyEA==" |    |
| 2001-01-03 00:00:00.000 | abc  |      |           |   1 | 6.0 | 6.0 | "AQAAAQAAAAEkAQ==" |    |
+-------------------------+------+------+-----------+-----+-----+-----+--------------------+----+
(8 rows)

!ok

select dim3,d3,dim2 from foo, unnest(MV_TO_ARRAY("dim3")) as u(d3);
+-----------+----+------+
| dim3      | d3 | dim2 |
+-----------+----+------+
|           |    | a    |
| ["a","b"] | a  | a    |
| ["a","b"] | b  | a    |
| ["b","c"] | b  |      |
| ["b","c"] | c  |      |
| d         | d  |      |
|           |    | abc  |
|           |    |      |
+-----------+----+------+
(8 rows)

!ok
